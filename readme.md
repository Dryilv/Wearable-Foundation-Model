# CWT-MAE 模型版本对比说明111

本项目包含两个版本的 CWT-MAE (Continuous Wavelet Transform Masked Autoencoder) 模型实现。以下是 `CWT_MAE_v1` 和 `CWT_MAE_v2` 的详细区别对比。

## 核心区别总结

| 特性 | CWT_MAE_v1 | CWT_MAE_v2 |
| :--- | :--- | :--- |
| **定位** | **多通道联合建模** (Multi-Channel Joint) | **长序列与特定任务优化** (Long-Sequence & Robust) |
| **输入处理** | 支持 `(B, M, L)` 多通道输入，通道间共享 Transformer 但保留独立性 | 侧重 `(B, L)` 单通道或通道独立处理，针对长序列优化 |
| **Patch Embedding** | **Decomposed (Conv Stem)**: 支持卷积 Stem (Conv-BN-GELU) 增强局部特征 | **Fixed Standard Conv**: 修正为标准 Conv2d，优化显存占用，避免大张量溢出 |
| **信号长度** | 默认 **1000** (支持滑动窗口切片) | 默认 **3000** (长序列建模) |
| **数据增强** | 基础 Z-Score 归一化，随机裁剪 | **PPG 专用增强** (翻转、缩放、基线漂移、带通滤波、Robust Norm) |
| **显存/效率** | 适合短序列、多通道数据 | 适合长序列、大规模预训练，内存更安全 |

---

## 1. 模型架构差异 (`model.py`)

### Patch Embedding 策略
*   **v1**: 提供了 `use_conv_stem` 选项。开启时使用多层卷积 (Conv-BN-GELU-Conv) 作为 Stem，有助于提取更细粒度的局部波形特征。
*   **v2**: 采用了 **内存安全版 (Memory-Safe)** 的 Patch Embedding。移除了复杂的分解卷积，直接使用标准的 `nn.Conv2d` 进行下采样。
    *   *原因*: v1 的分解版本在处理超长序列或大 Batch 时会产生巨大的中间张量 (如 `B x 768 x 64 x 3000`)，导致显存溢出或索引错误。v2 解决了这个问题。

### RoPE (旋转位置编码)
*   **v1**: 针对多通道 (`M`) 设计了特殊的 `pos_ids` 构建逻辑。不同通道在同一时刻共享相同的 RoPE 旋转角度，强调了时间对齐的物理意义。
*   **v2**: 简化了 `pos_ids` 生成逻辑，适配标准的 ViT 输入格式。

### 输入维度
*   **v1**: 显式处理 `(B, M, L)`，在 Encoder 前将 `M` 个通道展平到 Sequence 维度 (`B * M`)，并在输出时还原。
*   **v2**: 逻辑更接近标准 ViT，通常处理 `(B, L)` 或将通道视为 Batch 的一部分。

---

## 2. 数据处理与增强 (`dataset.py`)

### v1: 通用生理信号加载
*   **滑动窗口**: 支持 `stride` 参数，可以从长信号中切出多个重叠样本 (Overlapping Windows)。
*   **基础过滤**: 基于最大绝对值 (`max_abs_value`) 和标准差阈值过滤异常样本。
*   **归一化**: 使用标准的 `(x - mean) / std` Z-Score 归一化。

### v2: 鲁棒性与特定任务 (PPG)
*   **PPG 专用增强 (`dataset_cls.py`)**:
    *   **垂直翻转**: 模拟传感器佩戴方向差异。
    *   **基线漂移**: 加入正弦波噪声模拟呼吸干扰。
    *   **带通滤波**: 0.5-8Hz 巴特沃斯滤波，去除高频肌电噪声。
    *   **Robust Norm**: 使用四分位距 (IQR) 进行归一化，比 Z-Score 对异常值更鲁棒。
*   **长序列支持**: 默认配置为 30秒 (3000点) 信号，移除了滑动窗口逻辑，专注于长时程特征学习。

---

## 3. 配置参数 (`config.yaml`)

| 参数 | v1 (默认) | v2 (默认) | 说明 |
| :--- | :--- | :--- | :--- |
| `signal_len` | 1000 | 3000 | v2 训练序列更长 |
| `patch_size_time` | 25 | 50 | v2 使用更大的 Patch 以适配长序列 |
| `batch_size` | 128 | 256 | v2 优化后支持更大 Batch |
| `use_conv_stem` | True | (移除) | v1 强调局部特征，v2 强调显存效率 |
| `mlp_rank_ratio` | 0.5 | 0.5 | 两者均使用 Tensorized Linear 压缩参数 |

## 建议使用场景

*   **选择 v1**: 如果你的数据是**多通道同步信号** (如 12导联 ECG, 多通道 EEG)，且显存允许，v1 的 Conv Stem 和多通道 RoPE 设计可能带来更好的细节捕捉能力。
*   **选择 v2**: 如果你需要处理**长序列** (如 30秒 PPG/ECG)，或者显存受限，或者进行**下游分类任务** (特别是 PPG)，v2 的内存优化和强大的数据增强模块是更好的选择。
